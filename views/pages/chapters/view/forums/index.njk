<ul class="forums">
	{% include "./style.njk" %}
	{% lookup 'users', {_id: userid}, 'user' %}
	{% lookup 'chapters', {_id: chapterid}, 'chapter' %}

	{% query 'categories', {chapter: chapter._id}, {sort: [['order', 1]]}, 'categories' %}
	{% for category in categories %}
		{% if not category.role or user.role >= category.role %}
			<li class="category">
				<ul>
					<li>{{category.name}}</li>
					<li>Topics</li>
					<li>Most Recent</li>
				</ul>
			</li>

			{% query 'forums', {category: category._id}, {sort: [['order', 1]]}, 'forums' %}
			{% for forum in forums %}
				{% query 'topics', {parent: forum._id}, {sort: [['date', -1]]}, 'topics' %}

				<li class="forum">
					<ul>
						<li>
							<a class="forum-name" href="/forums/{{forum.slug}}">{{forum.name}}</a>
							<div class="forum-desc">{{forum.desc}}</div>
						</li>
						<li>{{topics.length}}</li>
						<li>
							{% if topics[0] %}
								{% lookup 'users', {_id: topics[0].author}, 'author' %}
								<a href="/forums/{{forum.slug}}/{{topics[0]._id}}">{{topics[0].title}}</a> by <a href="/members/{{author.nicename}}">{{author.display_name}}</a>
							{% else %}
								No Topics
							{% endif %}

							{% if crp.chapters.getMember(chapter, user._id).role >= 2 or user.role >= 3 %}
								<a class="meta" onclick="chaptersDeleteForum('{{forum._id}}')">Delete</a>
							{% endif %}
						</li>
					</ul>
				</li>
			{% endfor %}

			{% if crp.chapters.getMember(chapter, user._id).role >= 2 or user.role >= 3 %}
				<fieldset class="new-post">
					<legend>New Forum</legend>
					<form>
						<label for="name">Forum Name (Max: 80)</label>
						<input type="text" name="name" class="name" />

						<label for="desc">Forum Description (Max: 140)</label>
						<input type="text" name="desc" class="desc" />

						<input type="hidden" name="category" class="category" value="{{category._id}}" />
						<input type="submit" value="Create" />
						<span class="forum-error"></span>
					</form>
				</fieldset>
			{% endif %}
		{% endif %}
	{% endfor %}

	{% include "./script.njk" %}
</ul>
